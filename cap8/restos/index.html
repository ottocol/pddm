



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Restos - PDDM-iOS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#apendice-migraciones-ligeras-en-ios10" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="PDDM-iOS" class="md-header-nav__button md-logo">
          
            <img src="../../logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              PDDM-iOS
            </span>
            <span class="md-header-nav__topic">
              
                Restos
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="PDDM-iOS" class="md-nav__button md-logo">
      
        <img src="../../logo.png" width="48" height="48">
      
    </a>
    PDDM-iOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Persistencia básica
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Persistencia básica
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.1_sistema_de_archivos/" title="Sistema de archivos" class="md-nav__link">
      Sistema de archivos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.2_serializacion/" title="Serialización" class="md-nav__link">
      Serialización
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.3_property_lists/" title="Property lists" class="md-nav__link">
      Property lists
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.4_preferencias/" title="Preferencias" class="md-nav__link">
      Preferencias
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.5_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      SQLite
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        SQLite
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap2/2.1_intro_SQLite/" title="Introducción" class="md-nav__link">
      Introducción
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap2/2.2_API_SQLite/" title="El API de SQLIte" class="md-nav__link">
      El API de SQLIte
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap2/2.3_frameworks/" title="Frameworks para SQLite" class="md-nav__link">
      Frameworks para SQLite
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap2/2.4_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      ¡Hola Core Data!. Una aplicación de ejemplo
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        ¡Hola Core Data!. Una aplicación de ejemplo
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap3/3.1_intro/" title="Introducción a Core Data" class="md-nav__link">
      Introducción a Core Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap3/3.2_stack/" title="Crear el stack de Core Data en iOS" class="md-nav__link">
      Crear el stack de Core Data en iOS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap3/3.3_entidades/" title="Las entidades. Almacenar datos" class="md-nav__link">
      Las entidades. Almacenar datos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap3/3.4_recuperar_datos/" title="Recuperar los datos" class="md-nav__link">
      Recuperar los datos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap3/apendice_ver_almacenamiento/" title="Apéndice. Cómo examinar el almacenamiento persistente" class="md-nav__link">
      Apéndice. Cómo examinar el almacenamiento persistente
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Modelos de datos en Core Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Modelos de datos en Core Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap4/4.1_crear_modelo/" title="Crear y editar modelos" class="md-nav__link">
      Crear y editar modelos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap4/4.2_clases_propias/" title="Modelar las entidades en código Swift" class="md-nav__link">
      Modelar las entidades en código Swift
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap4/4.3_CRUD/" title="CRUD en Core Data" class="md-nav__link">
      CRUD en Core Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap4/4.4_validaciones/" title="Validaciones" class="md-nav__link">
      Validaciones
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap4/4.5_transformables/" title="Transformables" class="md-nav__link">
      Transformables
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap4/4.6_ejercicios/" title="Ejercicios de modelos de datos" class="md-nav__link">
      Ejercicios de modelos de datos
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Búsquedas en Core Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Búsquedas en Core Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap6/1_predicados/" title="Predicados" class="md-nav__link">
      Predicados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap6/2_ordenacion/" title="Ordenación" class="md-nav__link">
      Ordenación
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap6/3_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Tablas en Core Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Tablas en Core Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap7/1_el_frc/" title="El *fetched results controller*" class="md-nav__link">
      El *fetched results controller*
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap7/2_configuracion_basica/" title="Inicializar el "fetched results controller"" class="md-nav__link">
      Inicializar el "fetched results controller"
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap7/3_tabla/" title="Mostrar los datos en la tabla" class="md-nav__link">
      Mostrar los datos en la tabla
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap7/4_refrescar_tabla/" title="Refrescar la tabla" class="md-nav__link">
      Refrescar la tabla
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap7/5_secciones/" title="Secciones de tabla automáticas" class="md-nav__link">
      Secciones de tabla automáticas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap7/6_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Migraciones de datos
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Migraciones de datos
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../1_intro/" title="Qué son las migraciones de datos" class="md-nav__link">
      Qué son las migraciones de datos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../2_versiones/" title="Versiones del modelo de datos" class="md-nav__link">
      Versiones del modelo de datos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../3_migraciones_ligeras/" title="Migraciones ligeras" class="md-nav__link">
      Migraciones ligeras
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../4_migraciones_pesadas/" title="Migraciones pesadas" class="md-nav__link">
      Migraciones pesadas
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../5_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../apendice_migraciones_ios9/" title="Apéndice. migraciones en versiones antiguas de iOS" class="md-nav__link">
      Apéndice. migraciones en versiones antiguas de iOS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Concurrencia. Contextos múltiples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Concurrencia. Contextos múltiples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap9/1_background/" title="Múltiples contextos para trabajos en *background*" class="md-nav__link">
      Múltiples contextos para trabajos en *background*
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap9/2_comunicacion/" title="Comunicación entre contextos" class="md-nav__link">
      Comunicación entre contextos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap9/3_contextos_anidados/" title="Contextos anidados" class="md-nav__link">
      Contextos anidados
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap9/4_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Miniproyecto
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Miniproyecto
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../miniproyecto/restaurante/" title="Enunciado" class="md-nav__link">
      Enunciado
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Persistencia como servicio
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Persistencia como servicio
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap11/1_introduccion_BAAS/" title="Backend as a Service" class="md-nav__link">
      Backend as a Service
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap11/2_gestion_usuarios/" title="Gestión de usuarios en Firebase" class="md-nav__link">
      Gestión de usuarios en Firebase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap11/3_persistencia/" title="Persistencia en Firebase" class="md-nav__link">
      Persistencia en Firebase
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap11/4_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      Arquitecturas de aplicaciones en iOS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        Arquitecturas de aplicaciones en iOS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/intro/" title="Introducción" class="md-nav__link">
      Introducción
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/2_MVC/" title="Model/View/Controller" class="md-nav__link">
      Model/View/Controller
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/3_MVP/" title="Model/View/Presenter" class="md-nav__link">
      Model/View/Presenter
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/4_MVVM/" title="Model/View/ViewModel" class="md-nav__link">
      Model/View/ViewModel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/5_VIPER/" title="VIPER" class="md-nav__link">
      VIPER
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/6a_ejercicios1/" title="Ejercicios parte I" class="md-nav__link">
      Ejercicios parte I
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/6_ejercicios/" title="Ejercicios parte II" class="md-nav__link">
      Ejercicios parte II
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap10/6_ejercicios_redux/" title="Ejercicios parte III" class="md-nav__link">
      Ejercicios parte III
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#apendice-migraciones-ligeras-en-ios10" class="md-nav__link">
    Apéndice: migraciones ligeras en iOS&lt;10
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#versiones-del-modelo-de-datos" class="md-nav__link">
    Versiones del modelo de datos
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migraciones-ligeras" class="md-nav__link">
    Migraciones “ligeras”
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#migraciones-pesadas" class="md-nav__link">
    Migraciones “pesadas”
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#crear-el-mapping-model" class="md-nav__link">
    Crear el “mapping model”
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crear-la-migration-policy" class="md-nav__link">
    Crear la “migration policy”
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Restos</h1>
                
                <h2 id="apendice-migraciones-ligeras-en-ios10">Apéndice: migraciones ligeras en iOS&lt;10<a class="headerlink" href="#apendice-migraciones-ligeras-en-ios10" title="Permanent link">&para;</a></h2>
<p>Hay una serie de migraciones que Core Data puede hacer de forma más o menos automática. Por ejemplo al añadir un atributo se añadirá la nueva columna y simplemente los datos antiguos tendrán valor <code>nil</code> para la propiedad. O al cambiar una entidad de nombre se cambiará automáticamente el nombre de la tabla en la base de datos.</p>
<p><code>The model used to open the store is incompatible with the one used to create the store.</code></p>
<p>Este error es fácilmente subsanable yendo al directorio <code>Documents</code> de la aplicación y eliminando los ficheros del almacenamiento persistente (si es una BD SQLite, desde iOS7 hay 3 ficheros, un <code>.sqlite</code>, un <code>.sqlite-wal</code> y un <code>.sqlite-shm</code>). Si volvemos a arrancar la aplicación ya no habrá problema ya que no hay almacenamiento persistente y Core Data lo puede generar partiendo de cero. Pero evidentemente esto implica <strong>perder todos los datos que teníamos guardados</strong>. </p>
<p>En desarrollo perder los datos no tiene la menor importancia si tenemos el típico código de prueba que podemos volver a ejecutar para rellenar la BD. Pero si ya hemos distribuido la aplicación en la App Store y sacamos una nueva versión con el modelo de datos modificado, en principio todos los usuarios tendrían que borrar todos los datos para que les funcionara la nueva versión (!). Evidentemente esto no tiene sentido, tiene que haber alguna forma de que el modelo de datos pueda ir cambiando y los datos se vayan traspasando de una versión a otra. Este “traspaso” de los datos es lo que se conoce como una <strong>migración</strong>.</p>
<h2 id="versiones-del-modelo-de-datos">Versiones del modelo de datos<a class="headerlink" href="#versiones-del-modelo-de-datos" title="Permanent link">&para;</a></h2>
<h2 id="migraciones-ligeras">Migraciones “ligeras”<a class="headerlink" href="#migraciones-ligeras" title="Permanent link">&para;</a></h2>
<p>Las buenas noticias son que si los cambios en el modelo de datos no son demasiados, el propio Core Data puede hacer una migración automática, o como la llama Apple, “ligera” (<em>lightweight migration</em>).</p>
<p>Este tipo de migración se corresponde con estas operaciones:</p>
<ul>
<li>Añadir o eliminar un atributo o relación</li>
<li>Convertir en opcional un atributo requerido</li>
<li>Convertir en requerido un atributo opcional, siempre que se dé un valor por defecto</li>
<li>Añadir o eliminar una entidad</li>
<li>Renombrar un atributo o relación</li>
<li>Renombrar una entidad</li>
</ul>
<p>Si hemos hecho alguno/s de los <strong>cambios anteriores que no implican renombrado</strong>, la migración ligera es especialmente sencilla. Lo único que tenemos que hacer es modificar el código de inicialización del <code>NSPersistentStoreCoordinator</code>. En el <code>addPersistentStoreWithType</code> , hay que pasar un par de opciones en el  parámetro <code>options</code> que indican que queremos una migración totalmente automática:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="bp">NSDictionary</span> <span class="o">*</span><span class="n">opts</span> <span class="o">=</span> <span class="l">@{</span>
      <span class="nl">NSMigratePersistentStoresAutomaticallyOption</span><span class="p">:</span> <span class="m">@YES</span><span class="p">,</span>
      <span class="nl">NSInferMappingModelAutomaticallyOption</span><span class="p">:</span> <span class="m">@YES</span>
<span class="l">}</span><span class="p">;</span>
<span class="p">[</span><span class="n">persistentStoreCoordinator</span> <span class="nl">addPersistentStoreWithType</span><span class="p">:</span><span class="n">NSSQLiteStoreType</span>
<span class="nl">configuration</span><span class="p">:</span><span class="nb">nil</span> <span class="nl">URL</span><span class="p">:</span><span class="n">storeURL</span> 
<span class="nl">options</span><span class="p">:</span><span class="n">opts</span> <span class="nl">error</span><span class="p">:</span><span class="o">&amp;</span><span class="n">error</span><span class="p">]</span>
</pre></div>
</td></tr></table>

<p>Ahora cuando ejecutemos la aplicación <strong>se detectará que la versión actual del modelo de datos es posterior a la que se usó para generar la base de datos</strong>. En consecuencia, tal y como acabamos de configurar en el código, los datos se migrarán automáticamente a la nueva versión de la BD.</p>
<p>Si renombramos algo el proceso es solo un poco más laborioso. Por ejemplo supongamos que en la aplicación de notas cambiamos el atributo <code>fecha</code>por <code>momento</code>. Habiendo cambiado el nombre, mantenemos seleccionado el atributo y en el panel de la derecha, tercer icono (Data Model Inspector), en el cuadro de texto llamado <code>Renaming ID</code> tecleamos el nombre antiguo. Con esto estamos especificando lo que en Core Data se llama un <em>mapping model</em>, es decir una asociación de elementos que permite pasar del modelo antiguo al nuevo.</p>
<p><img alt="" src="renaming%20id.png" /></p>
<blockquote>
<p>Por supuesto, todos los lugares del código donde antes se hiciera referencia al atributo <code>fecha</code> ahora habrá que cambiarlos para que reflejen el nuevo nombre. Core Data no va a ayudarnos en esto. </p>
</blockquote>
<h2 id="migraciones-pesadas">Migraciones “pesadas”<a class="headerlink" href="#migraciones-pesadas" title="Permanent link">&para;</a></h2>
<p>Puede haber cambios que no encajen en las operaciones previstas en las migraciones “ligeras”. Por ejemplo supongamos que queremos dividir un campo <code>apellidos</code> en <code>apellido1</code>y <code>apellido2</code> (o al contrario, partimos de dos y los queremos fusionar). En estos casos Core Data no puede inferir automáticamente la forma de transformar el modelo origen al modelo objetivo, y tenemos que especificar “manualmente” cómo hacer la transformación.</p>
<p>La transformación entre un modelo y otro se representa en iOS mediante un <em>mapping model</em>, y es lo que tenemos que proporcionarle a Core Data para que pueda actualizar los datos al nuevo modelo.</p>
<p>Lo que hará Core Data durante el proceso de migración es cargar cada entidad en memoria, convertirla del modelo actual al nuevo ayudándose del <em>mapping model</em> y guardarla de nuevo en el almacenamiento persistente. Y hemos dicho Core Data, pero en realidad lo que tendremos que hacer será escribir nosotros código que haga esta tarea. Además del trabajo para nosotros, las migraciones de este tipo son mucho más costosas en tiempo y capacidad de procesamiento que las ligeras. Normalmente la aplicación necesitará mostrar al usuario un cuadro de diálogo que le indique que se está realizando la operación.</p>
<p>Vamos a ver cómo se implementaría una migración “pesada” con un ejemplo concreto. Supongamos que en la aplicación de notas nos hemos dado cuenta de que el campo “categoria” no está del todo bien, ya que así solo podemos hacer que una nota pertenezca a una única categoría, y además cuando varias notas tienen la misma categoría cada una debe repetir el valor. Sería mejor tener una entidad “categoría” aparte y establecer una relación “uno a muchos” en ambas direcciones.</p>
<p>Lo primero es crear una nueva versión del modelo de datos con este cambio.</p>
<h3 id="crear-el-mapping-model">Crear el “mapping model”<a class="headerlink" href="#crear-el-mapping-model" title="Permanent link">&para;</a></h3>
<p>El nuevo modelo de datos tendrá el aspecto de la siguiente figura:</p>
<p><img alt="" src="modelo_datos_v3.png" /></p>
<p>ahora tenemos que crear el <em>mapping model</em> que nos transforme el modelo actual en el nuevo modelo. En <code>File &gt; New</code> seleccionamos la categoría <code>Core Data</code> y elegimos la plantilla <code>Mapping Model</code>. El asistente nos preguntará cuál es el modelo origen, cuál el destino, y nos pedirá un nombre para el nuevo archivo <code>.xcmappingmodel</code> que creará.</p>
<p>Si abrimos el archivo creado, veremos que Xcode ha intentado deducir la correspondencia entre el modelo origen y el destino. </p>
<p><img alt="" src="mapping_model.png" /></p>
<p>A la izquierda veremos los <em>Entity Mappings</em> (cómo pasar de una entidad antigua a una nueva). Típicamente a estos los llama con el nombre de la entidad antigua y la nueva, algo como <code>NotaToNota</code>. Para las entidades nuevas pone simplemente el nombre de la entidad. </p>
<p>Para cada Entity Mapping tenemos los <em>Attribute Mappings</em> y los <em>Relationship mappings</em> correspondientes. Se usa un conjunto de variables predefinido para expresarlos. Por ejemplo, <code>$source</code> indica la entidad origen. De modo que si en un atributo vemos <code>$source.texto</code> indica que Xcode ha deducido que para generar este atributo tenemos que copiar el valor del atributo <code>texto</code> de la entidad original. Para una lista de variables se recomienda consultar la <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreDataVersioning/Articles/vmMappingOverview.html#//apple_ref/doc/uid/TP40004399-CH5-SW1">sección correspondiente</a> de la “<a href="https://developer.apple.com/library/ios/documentation/Cocoa/Conceptual/CoreDataVersioning/Articles/Introduction.html#//apple_ref/doc/uid/TP40004399-CH1-SW1">Core Data Model Versioning and Data Migration Programming Guide</a>”.</p>
<h3 id="crear-la-migration-policy">Crear la “migration policy”<a class="headerlink" href="#crear-la-migration-policy" title="Permanent link">&para;</a></h3>
<p>De la migración entre entidades del modelo “antiguo” y del “nuevo” se encarga la clase <code>NSEntityMigrationPolicy</code>. Si queremos personalizar la migración, como es nuestro caso para generar la nueva entidad <code>Categoria</code> a partir de los valores del antiguo atributo <code>categoria</code>, tendremos que crear una clase propia que herede de ella:</p>
<p><img alt="" src="create_migration_policy.png" /></p>
<p>Tendremos también que especificar en el Mapping Model que vamos a usar esta clase para hacer una migración de entidad determinada. Seleccionamos la migración <code>NotaToNota</code> y en las propiedades escribimos el nombre de la nueva clase en el campo <code>Custom Policy</code>.</p>
<p><img alt="" src="mapping_model_custom_policy.png" /></p>
<p>En la clase hay una serie de métodos que podemos sobreescribir para adaptar la migración a nuestras necesidades, pero el único que suele ser necesario es <code>createDestinationInstancesForSourceInstance:entityMapping:manager:error:</code>, que se encargaría de crear a partir de una instancia de la antigua entidad, la nueva entidad (o nuevas, si debe haber más de una). Este método se irá llamando para cada una de las entidades actualmente en el almacén persistente, para irlas migrando una a una. </p>
<p>Para nuestro problema particular, lo que debemos hacer en este método es obtener la categoría a la que pertenece la nota y crear una nueva entidad <code>Categoria</code> basada en ella. Después establecemos la relación entre la nota y su por ahora única categoría. Hay un pequeño problema a tener en cuenta: como habrá varias notas de la misma categoría no podemos crear directamente la entidad <code>Categoria</code>, solo la crearemos si no existe ya. Vamos a guardar las <code>Categoria</code> que creamos en un <code>NSMutableDictionary</code> para poder saber las que ya hemos creado. En nuestra clase definiríamos una variable <code>static</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>static NSMutableDictionary *categorias;
</pre></div>
</td></tr></table>

<p>y para inicializarla usaremos el método <code>initialize</code>, que se llama cuando se inicializa la clase propiamente dicha, antes de que exista todavía ninguna instancia de ella, momento apropiado para inicializar variables <code>static</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">initialize</span> <span class="p">{</span>
    <span class="n">categorias</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableDictionary</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Finalmente aquí tenemos el código que hace la migración en sí</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span> <span class="nf">createDestinationInstancesForSourceInstance:</span><span class="p">(</span><span class="bp">NSManagedObject</span> <span class="o">*</span><span class="p">)</span><span class="nv">sInstance</span> <span class="nf">entityMapping:</span><span class="p">(</span><span class="bp">NSEntityMapping</span> <span class="o">*</span><span class="p">)</span><span class="nv">mapping</span> <span class="nf">manager:</span><span class="p">(</span><span class="bp">NSMigrationManager</span> <span class="o">*</span><span class="p">)</span><span class="nv">manager</span> <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="k">__autoreleasing</span> <span class="o">*</span><span class="p">)</span><span class="nv">error</span> <span class="p">{</span>

    <span class="c1">//Crea una nueva nota en el &quot;nuevo modelo&quot; con las mismas propiedades que la nota actual</span>
    <span class="bp">NSManagedObject</span> <span class="o">*</span><span class="n">notaDestino</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSEntityDescription</span> <span class="nl">insertNewObjectForEntityForName</span><span class="p">:</span><span class="s">@&quot;Nota&quot;</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span><span class="n">manager</span><span class="p">.</span><span class="n">destinationContext</span><span class="p">];</span>
    <span class="p">[</span><span class="n">notaDestino</span> <span class="nl">setValue</span><span class="p">:[</span><span class="n">sInstance</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="s">@&quot;texto&quot;</span><span class="p">]</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;texto&quot;</span><span class="p">];</span>
    <span class="p">[</span><span class="n">notaDestino</span> <span class="nl">setValue</span><span class="p">:[</span><span class="n">sInstance</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="s">@&quot;momento&quot;</span><span class="p">]</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;momento&quot;</span><span class="p">];</span>

    <span class="c1">//Miramos si ya hemos creado una entidad Categoria para la categoria de la nota</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">nombreCategoria</span> <span class="o">=</span> <span class="p">[</span><span class="n">sInstance</span> <span class="nl">valueForKey</span><span class="p">:</span><span class="s">@&quot;categoria&quot;</span><span class="p">];</span>
    <span class="bp">NSManagedObject</span> <span class="o">*</span><span class="n">categoria</span> <span class="o">=</span> <span class="p">[</span><span class="n">categorias</span> <span class="nl">objectForKey</span><span class="p">:</span><span class="n">nombreCategoria</span><span class="p">];</span>

    <span class="c1">//Si no la hemos encontrado, la creamos</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">categoria</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">categoria</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSEntityDescription</span> <span class="nl">insertNewObjectForEntityForName</span><span class="p">:</span><span class="s">@&quot;Categoria&quot;</span> <span class="nl">inManagedObjectContext</span><span class="p">:</span><span class="n">manager</span><span class="p">.</span><span class="n">destinationContext</span><span class="p">];</span>
        <span class="p">[</span><span class="n">categoria</span> <span class="nl">setValue</span><span class="p">:</span><span class="n">nombreCategoria</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;nombre&quot;</span><span class="p">];</span>
        <span class="p">[</span><span class="n">categorias</span> <span class="nl">setObject</span><span class="p">:</span><span class="n">categoria</span> <span class="nl">forKey</span><span class="p">:</span><span class="n">nombreCategoria</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="c1">//Asociamos la nota con su por ahora única categoría</span>
    <span class="c1">//Como es una relación 1-&gt;N es un NSSet que por ahora tendrá un único elemento</span>
    <span class="bp">NSSet</span> <span class="o">*</span><span class="n">categoriasDeNota</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSSet</span> <span class="n">alloc</span><span class="p">]</span><span class="nl">initWithObjects</span><span class="p">:</span><span class="n">categoria</span><span class="p">,</span> <span class="nb">nil</span><span class="p">];</span>
    <span class="p">[</span><span class="n">notaDestino</span> <span class="nl">setValue</span><span class="p">:</span><span class="n">categoriasDeNota</span> <span class="nl">forKey</span><span class="p">:</span><span class="s">@&quot;categorias&quot;</span><span class="p">];</span>


    <span class="c1">//Al final siempre hay que llamar a este método para establecer correspondencia</span>
    <span class="c1">//entre entidad en el modelo actual y entidad en el nuevo</span>
    <span class="p">[</span><span class="n">manager</span> <span class="nl">associateSourceInstance</span><span class="p">:</span><span class="n">sInstance</span> <span class="nl">withDestinationInstance</span><span class="p">:</span><span class="n">notaDestino</span> <span class="nl">forEntityMapping</span><span class="p">:</span><span class="n">mapping</span><span class="p">];</span>


    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Lo único que nos falta es configurar el <em>persistent store coordinator</em> para especificar que necesitamos una migración “pesada”. Al igual que en el caso de las migraciones “ligeras”, esto se hace con un diccionario de opciones. La diferencia es que en este caso indicamos que no se intente inferir automáticamente el “mapping model”</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>NSDictionary *opts = @{
      NSMigratePersistentStoresAutomaticallyOption: @YES,
      NSInferMappingModelAutomaticallyOption: @NO
};
</pre></div>
</td></tr></table>

<p>Y ya está. Solo nos falta en el editor del modelo de datos <em>establecer como versión actual del modelo de datos la nueva versión</em></p>
<p><img alt="" src="set_current_model_version.png" /></p>
<p>Cuando arranque la aplicación iOS detectará que el modelo de datos actual es incompatible con el almacén persistente y verá que en las opciones se especifica que no se debe inferir automáticamente el “mapping model”. Por tanto buscará un “mapping model” compatible con la versión origen y destino del modelo de datos y lo aplicará.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>