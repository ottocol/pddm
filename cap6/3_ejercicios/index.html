



<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>3 ejercicios - PDDM-iOS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="teal">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#preparacion-de-la-interfaz-1-punto" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="PDDM-iOS" class="md-header-nav__button md-logo">
          
            <img src="../../logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              PDDM-iOS
            </span>
            <span class="md-header-nav__topic">
              
                3 ejercicios
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="PDDM-iOS" class="md-nav__button md-logo">
      
        <img src="../../logo.png" width="48" height="48">
      
    </a>
    PDDM-iOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1">
    
    <label class="md-nav__link" for="nav-1">
      Persistencia básica
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        Persistencia básica
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.1_sistema_de_archivos/" title="Sistema de archivos" class="md-nav__link">
      Sistema de archivos
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.2_serializacion/" title="Serialización" class="md-nav__link">
      Serialización
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.3_property_lists/" title="Property lists" class="md-nav__link">
      Property lists
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.4_preferencias/" title="Preferencias" class="md-nav__link">
      Preferencias
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../cap1/1.5_ejercicios/" title="Ejercicios" class="md-nav__link">
      Ejercicios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#preparacion-de-la-interfaz-1-punto" class="md-nav__link">
    Preparación de la interfaz (1 punto)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementacion-del-codigo-de-busqueda-25-puntos" class="md-nav__link">
    Implementación del código de búsqueda (2.5 puntos)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#throttling-de-las-busquedas-05-puntos" class="md-nav__link">
    Throttling de las búsquedas (0,5 puntos)
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>3 ejercicios</h1>
                
                <p>Vamos a implementar una búsqueda por texto en la aplicación de notas sobre la que estáis trabajando en estas sesiones.</p>
<blockquote>
<p>Antes de ponerte a hacer las modificaciones de esta sesión asegúrate de que has hecho un <code>commit</code> con el mensaje <code>terminada sesión 4</code>. También puedes hacer un <code>.zip</code> con el proyecto, llamarlo <code>notas_sesion_4.zip</code> y adjuntarlo en las entregas de la asignatura. Así cuando se evalúe el ejercicio el profesor podrá consultar el estado que tenía la aplicación antes de estos ejercicios.</p>
</blockquote>
<h3 id="preparacion-de-la-interfaz-1-punto">Preparación de la interfaz (1 punto)<a class="headerlink" href="#preparacion-de-la-interfaz-1-punto" title="Permanent link">&para;</a></h3>
<p>Necesitamos una barra de búsqueda para poder introducir la cadena de texto a buscar. Usaremos un <code>UISearchController</code>. Este componente incluye la <em>search bar</em>. </p>
<p>En <code>ListaNotasController</code>:</p>
<ol>
<li>Define una propiedad que será el <code>UISearchController</code></li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">//esto debe ser una variable miembro de ListaNotasController</span>
<span class="kd">let</span> <span class="nv">searchController</span> <span class="p">=</span> <span class="bp">UISearchController</span><span class="p">(</span><span class="n">searchResultsController</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<ol start="2">
<li>En el <code>viewDidLoad</code> introduce el siguiente código, que configura e inicializa el <code>UISearchController</code></li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">//iOS intentará pintar la tabla, hay que inicializarla aunque sea vacía</span>
<span class="kc">self</span><span class="p">.</span><span class="n">listaNotas</span> <span class="p">=</span> <span class="p">[]</span>
<span class="c1">//ListaNotasController recibirá lo que se está escribiendo en la barra de búsqueda </span>
<span class="n">searchController</span><span class="p">.</span><span class="n">searchResultsUpdater</span> <span class="p">=</span> <span class="kc">self</span>
<span class="c1">//Configuramos el search controller</span>
<span class="n">searchController</span><span class="p">.</span><span class="n">obscuresBackgroundDuringPresentation</span> <span class="p">=</span> <span class="kc">false</span>
<span class="n">searchController</span><span class="p">.</span><span class="n">searchBar</span><span class="p">.</span><span class="n">placeholder</span> <span class="p">=</span> <span class="s">&quot;Buscar texto&quot;</span>
<span class="c1">//Lo añadimos a la tabla</span>
<span class="n">searchController</span><span class="p">.</span><span class="n">searchBar</span><span class="p">.</span><span class="n">sizeToFit</span><span class="p">()</span>
<span class="kc">self</span><span class="p">.</span><span class="n">tableView</span><span class="p">.</span><span class="n">tableHeaderView</span> <span class="p">=</span> <span class="n">searchController</span><span class="p">.</span><span class="n">searchBar</span>
</pre></div>
</td></tr></table>

<ol start="3">
<li>La propiedad <code>searchResultsUpdater</code> indica quién es el <em>delegate</em> del <code>UISearchController</code>, en este caso <code>ListaNotasViewController</code>. El <em>delegate</em> debe ser conforme al protocolo <code>UISearchResultsUpdating</code>, que requiere que se implemente un método llamado <code>updateSearchResults(for:)</code>.</li>
</ol>
<p>Cambia la cabecera de <code>ListaNotasViewController</code> para declarar que es conforme al protocolo <code>UISearchResultsUpdating</code>:</p>
<p><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">class</span> <span class="nc">ListaViewController</span><span class="p">:</span> <span class="bp">UITableViewController</span><span class="p">,</span> <span class="bp">UISearchResultsUpdating</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>  
</pre></div>
</td></tr></table>
Define en la clase el método <code>updateSearchResults(for:)</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">updateSearchResults</span><span class="p">(</span><span class="k">for</span> <span class="n">searchController</span><span class="p">:</span> <span class="bp">UISearchController</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">texto</span> <span class="p">=</span> <span class="n">searchController</span><span class="p">.</span><span class="n">searchBar</span><span class="p">.</span><span class="n">text</span><span class="p">!</span>
    <span class="bp">print</span><span class="p">(</span><span class="s">&quot;Buscando </span><span class="si">\(</span><span class="n">texto</span><span class="si">)</span><span class="s">&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p><strong>Prueba la aplicación</strong> para comprobar que todo está correcto, y deberías ver que cada vez que se escribe en la barra de búsqueda se llama a este método y se imprime en la consola la cadena buscada.</p>
<h3 id="implementacion-del-codigo-de-busqueda-25-puntos">Implementación del código de búsqueda (2.5 puntos)<a class="headerlink" href="#implementacion-del-codigo-de-busqueda-25-puntos" title="Permanent link">&para;</a></h3>
<blockquote>
<p><code>updateSearchResults</code> se llama por cada nuevo carácter escrito en la barra de búsquedas, lo que permite actualizar los datos en "tiempo real" pero es muy ineficiente. Veremos cómo solucionarlo en el siguiente apartado, de momento dispararemos una nueva búsqueda por cada pulsación</p>
</blockquote>
<p>Hecha la preparación de la interfaz, falta implementar la búsqueda en sí. En el método <code>updateSearchResults</code> <strong>debes crear una fetch request que busque las notas cuyo texto contenga el texto escrito</strong> en la barra de búsqueda, sin distinguir mayúsculas/minúsculas o caracteres diacríticos. </p>
<p>Recuerda que para que se actualicen los datos visibles debes llamar a <code>tableView.reloadData()</code></p>
<p>Una vez comprobado que funciona, <strong>mejora la fetch request para que las notas aparezcan en orden inverso por fecha</strong>, de más reciente a más antigua.</p>
<h3 id="throttling-de-las-busquedas-05-puntos"><em>Throttling</em> de las búsquedas (0,5 puntos)<a class="headerlink" href="#throttling-de-las-busquedas-05-puntos" title="Permanent link">&para;</a></h3>
<p>Lanzar una nueva <em>fetch request</em> por cada carácter tecleado es muy ineficiente, sobre todo si el usuario teclea rápido y ni siquiera da tiempo a ver los resultados intermedios. Una implementación mejor haría <em>throttling</em> de la búsqueda, es decir, impediría que se repita la operación si todavía no ha pasado un mínimo de tiempo desde la anterior.</p>
<p>La idea es que si se intenta repetir la operación y todavía no ha pasado un tiempo prefijado por nosotros, la nueva operación se retrase hasta que pase el intervalo de tiempo. Esto no está implementado en los APIs de iOS pero en Internet vpodéis encontrar diversas implementaciones. La siguiente clase, tomada de <a href="https://www.craftappco.com/blog/2018/5/30/simple-throttling-in-swift">este tutorial</a>, implementa esta funcionalidad.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">import</span> <span class="nc">Foundation</span>

<span class="c1">//De https://www.craftappco.com/blog/2018/5/30/simple-throttling-in-swift</span>
<span class="kd">class</span> <span class="nc">Throttler</span> <span class="p">{</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">workItem</span><span class="p">:</span> <span class="n">DispatchWorkItem</span> <span class="p">=</span> <span class="n">DispatchWorkItem</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="p">{})</span>
    <span class="kd">private</span> <span class="kd">var</span> <span class="nv">previousRun</span><span class="p">:</span> <span class="n">Date</span> <span class="p">=</span> <span class="n">Date</span><span class="p">.</span><span class="n">distantPast</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">queue</span><span class="p">:</span> <span class="n">DispatchQueue</span>
    <span class="kd">private</span> <span class="kd">let</span> <span class="nv">minimumDelay</span><span class="p">:</span> <span class="n">TimeInterval</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">minimumDelay</span><span class="p">:</span> <span class="n">TimeInterval</span><span class="p">,</span> <span class="n">queue</span><span class="p">:</span> <span class="n">DispatchQueue</span> <span class="p">=</span> <span class="n">DispatchQueue</span><span class="p">.</span><span class="n">main</span><span class="p">)</span> <span class="p">{</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">minimumDelay</span> <span class="p">=</span> <span class="n">minimumDelay</span>
        <span class="kc">self</span><span class="p">.</span><span class="n">queue</span> <span class="p">=</span> <span class="n">queue</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">throttle</span><span class="p">(</span><span class="kc">_</span> <span class="n">block</span><span class="p">:</span> <span class="p">@</span><span class="n">escaping</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="nb">Void</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Cancel any existing work item if it has not yet executed</span>
        <span class="n">workItem</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="c1">// Re-assign workItem with the new block task, resetting the previousRun time when it executes</span>
        <span class="n">workItem</span> <span class="p">=</span> <span class="n">DispatchWorkItem</span><span class="p">()</span> <span class="p">{</span>
            <span class="p">[</span><span class="kr">weak</span> <span class="kc">self</span><span class="p">]</span> <span class="k">in</span>
            <span class="kc">self</span><span class="p">?.</span><span class="n">previousRun</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()</span>
            <span class="n">block</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1">// If the time since the previous run is more than the required minimum delay</span>
        <span class="c1">// =&gt; execute the workItem immediately</span>
        <span class="c1">// else</span>
        <span class="c1">// =&gt; delay the workItem execution by the minimum delay time</span>
        <span class="kd">let</span> <span class="nv">delay</span> <span class="p">=</span> <span class="n">previousRun</span><span class="p">.</span><span class="n">timeIntervalSinceNow</span> <span class="o">&gt;</span> <span class="n">minimumDelay</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">minimumDelay</span>
        <span class="n">queue</span><span class="p">.</span><span class="n">asyncAfter</span><span class="p">(</span><span class="n">deadline</span><span class="p">:</span> <span class="p">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Double</span><span class="p">(</span><span class="n">delay</span><span class="p">),</span> <span class="n">execute</span><span class="p">:</span> <span class="n">workItem</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Crea un nuevo fichero Swift en tu proyecto con esta clase. Para usarlo en <code>ListaNotasViewController</code>:</p>
<ol>
<li>Define una variable miembro de tipo <code>Throttler</code> con el intervalo de tiempo deseado, por ejemplo 0.5 segundos (no queremos repetir búsquedas con más frecuencia)</li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">let</span> <span class="nv">throttler</span> <span class="p">=</span> <span class="n">Throttler</span><span class="p">(</span><span class="n">minimumDelay</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<ol start="2">
<li>En el <code>updateSearchResults</code> "envuelve" tu código de búsqueda en un <code>throttle</code>. Automáticamente la clase <code>Throttler</code> se encargará de que el código no se ejecute más de 1 vez por cada 0.5 segundos (o el intervalo que hayas elegido)</li>
</ol>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">func</span> <span class="nf">updateSearchResults</span><span class="p">(</span><span class="k">for</span> <span class="n">searchController</span><span class="p">:</span> <span class="bp">UISearchController</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">throttler</span><span class="p">.</span><span class="n">throttle</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">texto</span> <span class="p">=</span> <span class="n">searchController</span><span class="p">.</span><span class="n">searchBar</span><span class="p">.</span><span class="n">text</span><span class="p">!</span>
        <span class="c1">//Aquí iría tu código de búsqueda</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>