
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.2, mkdocs-material-7.3.2">
    
    
      
        <title>4 MVVM - PDDM-iOS</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.24c991ad.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mvvm" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="PDDM-iOS" class="md-header__button md-logo" aria-label="PDDM-iOS" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PDDM-iOS
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4 MVVM
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Búsqueda" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Limpiar" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="PDDM-iOS" class="md-nav__button md-logo" aria-label="PDDM-iOS" data-md-component="logo">
      
  <img src="../../logo.png" alt="logo">

    </a>
    PDDM-iOS
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Persistencia básica
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Persistencia básica" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Persistencia básica
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap1/1.0_introduccion/" class="md-nav__link">
        Introducción
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap1/1.1_sistema_de_archivos/" class="md-nav__link">
        Sistema de archivos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap1/1.2_serializacion/" class="md-nav__link">
        Serialización
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap1/1.3_property_lists/" class="md-nav__link">
        Property lists
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap1/1.4_preferencias/" class="md-nav__link">
        Preferencias
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          ¡Hola Core Data!. Una aplicación de ejemplo
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="¡Hola Core Data!. Una aplicación de ejemplo" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          ¡Hola Core Data!. Una aplicación de ejemplo
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap3/3.1_intro/" class="md-nav__link">
        Introducción a Core Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap3/3.2_stack/" class="md-nav__link">
        Crear el stack de Core Data en iOS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap3/3.3_entidades/" class="md-nav__link">
        Ejercicio parte I. almacenar datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap3/3.4_recuperar_datos/" class="md-nav__link">
        Ejercicio parte II. recuperar los datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap3/apendice_ver_almacenamiento/" class="md-nav__link">
        Apéndice. Cómo examinar el almacenamiento persistente
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Modelos de datos en Core Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Modelos de datos en Core Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Modelos de datos en Core Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap4/4.1_crear_modelo/" class="md-nav__link">
        Crear y editar modelos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap4/4.2_clases_propias/" class="md-nav__link">
        Modelar las entidades en código Swift
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap4/4.3_CRUD/" class="md-nav__link">
        CRUD en Core Data
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap4/4.4_validaciones/" class="md-nav__link">
        Validaciones
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap4/4.5_transformables/" class="md-nav__link">
        Transformables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap4/4.6_ejercicios/" class="md-nav__link">
        Ejercicios de modelos de datos
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Búsquedas en Core Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Búsquedas en Core Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Búsquedas en Core Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap6/1_predicados/" class="md-nav__link">
        Predicados
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap6/2_ordenacion/" class="md-nav__link">
        Ordenación
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap6/3_ejercicios/" class="md-nav__link">
        Ejercicios
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Tablas en Core Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tablas en Core Data" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Tablas en Core Data
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap7/1_el_frc/" class="md-nav__link">
        El "fetched results controller"
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap7/2_configuracion_basica/" class="md-nav__link">
        Inicializar el "fetched results controller"
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap7/3_tabla/" class="md-nav__link">
        Mostrar los datos en la tabla
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap7/4_refrescar_tabla/" class="md-nav__link">
        Refrescar la tabla
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap7/5_secciones/" class="md-nav__link">
        Secciones de tabla automáticas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap7/6_ejercicios/" class="md-nav__link">
        Ejercicios
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Miniproyecto
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Miniproyecto" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Miniproyecto
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../miniproyecto/restaurante/" class="md-nav__link">
        Enunciado
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Migraciones de datos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Migraciones de datos" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Migraciones de datos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap8/1_intro/" class="md-nav__link">
        Qué son las migraciones de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap8/2_versiones/" class="md-nav__link">
        Versiones del modelo de datos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap8/3_migraciones_ligeras/" class="md-nav__link">
        Migraciones ligeras
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap8/4_migraciones_pesadas/" class="md-nav__link">
        Migraciones pesadas
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap8/5_ejercicios/" class="md-nav__link">
        Ejercicios
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Concurrencia. Contextos múltiples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Concurrencia. Contextos múltiples" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Concurrencia. Contextos múltiples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap9/1_background/" class="md-nav__link">
        Múltiples contextos para trabajos en background
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap9/2_comunicacion/" class="md-nav__link">
        Comunicación entre contextos
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../cap9/3_contextos_anidados/" class="md-nav__link">
        Contextos anidados
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Tabla de contenidos">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Tabla de contenidos
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mvvm" class="md-nav__link">
    MVVM
  </a>
  
    <nav class="md-nav" aria-label="MVVM">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mvvm-vs-mvp" class="md-nav__link">
    MVVM vs. MVP
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mvvm-con-la-libreria-bond" class="md-nav__link">
    MVVM con la librería "Bond"
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>4 MVVM</h1>
                
                <h2 id="mvvm">MVVM<a class="headerlink" href="#mvvm" title="Permanent link">&para;</a></h2>
<h3 id="mvvm-vs-mvp">MVVM vs. MVP<a class="headerlink" href="#mvvm-vs-mvp" title="Permanent link">&para;</a></h3>
<p>El patrón de diseño Model/View/ViewModel es muy similar al MVP que vimos en el apartado anterior. </p>
<p><img alt="" src="../img/mvvm.png" /></p>
<p>De hecho, el <em>ViewModel</em> tiene más o menos la misma funcionalidad que el <em>presenter</em>, implementar la lógica de presentación y aislarla de la tecnología concreta usada para la presentación.</p>
<p>¿Dónde está la diferencia entonces?. En que MVVM soluciona uno de los principales problemas que tiene MVP, el acoplamiento entre vista y <em>presenter</em>. Como estuvimos discutiendo, la <em>vista</em> y el <em>presenter</em> deben "conocerse" mutuamente, ya que la vista debe comunicarle a este las acciones del usuario, y el <em>presenter</em> enviarle a la vista los datos a mostrar. Esto hace que ambos componentes estén acoplados entre sí, ya hemos visto en el código de ejemplo de MVP que en la vista hay una referencia al <em>presenter</em> y viceversa. En MVVM no existe este acoplamiento, y lo vamos a evitar usando <em>bindings</em>, es decir, vinculación automática entre los datos de la modelo y el <em>presenter</em>, de manera que cuando cambie alguno de ellos se modifique automáticamente el otro. Esto permite que el código quede mucho más "limpio", ya que no hay que actualizar el otro componente de modo explícito.</p>
<p>En iOS no hay ninguna tecnología estándar para vincular elementos de la vista con propiedades del modelo (aunque en OSX sí existe). Podríamos usar KVO o notificaciones para hacer la vinculación, pero la implementación sería un poco tediosa. Así que tendremos que usar alguna librería de terceros. Aquí veremos una bastante sencilla de usar llamada <a href="https://github.com/ReactiveKit/Bond">Bond</a> (el nombre completo es Bond, Swift Bond :)).</p>
<blockquote>
<p>Para implementar los <em>bindings</em> podríamos usar también algún <em>framework</em> de <em>reactive programming</em>. Este paradigma de programación permite implementar la funcionalidad de manera bastante elegante. No obstante usar un <em>framework</em> de este tipo solo para implementar <em>bindings</em> probablemente sea demasiado, ya que la idea de <em>reactive programming</em> es bastante más amplia. En cualquier caso es posible que encontréis tutoriales y otros recursos de MVVM en iOS que usen <em>frameworks</em> reactivos como <a href="https://github.com/ReactiveCocoa/ReactiveCocoa">ReactiveCocoa</a> o <a href="https://github.com/ReactiveX/RxSwift">RXSwift</a>. De hecho, Bond está construido sobre un <em>framework</em> de este tipo, aunque más sencillo. Y como se verá, en el ejemplo usaremos funcionalidades típicas de <em>programación reactiva</em>.</p>
</blockquote>
<h3 id="mvvm-con-la-libreria-bond">MVVM con la librería "Bond"<a class="headerlink" href="#mvvm-con-la-libreria-bond" title="Permanent link">&para;</a></h3>
<p>Vamos a verlo con un ejemplo, ya que así se entenderán mejor los conceptos. Implementaremos ahora una versión MVVM de la aplicación <code>UAdivino</code>, al estilo de la que hicimos en el apartado anterior, es decir, mostrando cada tipo de respuesta de un color distinto. La diferencia fundamental va a estar en que vincularemos de modo automático tanto el texto de la respuesta como el color para que no haga falta fijarlos de forma explícita en la vista. Esta vinculación la haremos gracias a la librería Bond.</p>
<p>La forma más sencilla de configurar un proyecto de Xcode con Bond es usando Cocoapods. En el README de Bond en Github están <a href="https://github.com/ReactiveKit/Bond#installation">las instrucciones</a>. Vamos a empezar a trabajar suponiendo que ya se ha hecho esta configuración. Como en el caso de la versión MVP podéis consultar el <a href="https://github.com/ottocol/ejemplos-arquitectura-iOS/tree/master/MVVM/UAdivino">código fuente completo</a> en GitHub.</p>
<h4 id="vinculacion-de-viewmodel-a-vista">Vinculación de <em>viewmodel</em> a vista<a class="headerlink" href="#vinculacion-de-viewmodel-a-vista" title="Permanent link">&para;</a></h4>
<p>Al vincular un <em>origen</em> con un <em>destino</em> lo que hacemos es que cuando el primero cambia, el segundo también lo hace automáticamente. Esto simplifica mucho el código ya que podemos cambiar una propiedad del <em>viewmodel</em> y que se refleje automáticamente en la vista, o viceversa.</p>
<p>En nuestro ejemplo del <code>UAdivino</code> queremos vincular dos propiedades del <em>viewmodel</em> con la vista: el texto de la respuesta y el color de la misma. En la librería Bond los <em>bindings</em> se basan en la idea de <strong>observable</strong>. Esta es una idea similar a la de los eventos. Podemos indicar que queremos observar un elemento <em>observable</em> de modo que se nos "avisará" de cuándo cambia su valor. No obstante a diferencia de los eventos, que ya suelen estar predefinidos en el sistema, podemos crear los observables "bajo demanda" y además como veremos se pueden manipular, transformar y combinar permitiéndonos hacer cosas complejas de modo relativamente sencillo. La idea de observable es la idea fundamental tras el paradigma de <strong>programación reactiva</strong>, aunque en este paradigma suele recibir otros nombres, siendo el más típico el de <em>stream</em> (en librerías como ReactiveCocoa se denominan <em>signals</em>).</p>
<p>Así, definiremos el texto de la respuesta como un observable "de tipo" <code>String</code> en lugar de simplemente como un <code>String</code>, para poder vincularlo a la vista. En el <em>viewmodel</em> haríamos esto para crear el observable con un valor inicial de "" (cadena vacía):</p>
<div class="highlight"><pre><span></span><code><span class="kd">import</span> <span class="nc">Bond</span>

<span class="kd">let</span> <span class="nv">textoResp</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">&gt;(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Nótese que <code>textoResp</code> no es un <code>String</code> sino un <em>observable</em>. El valor que hay "dentro" del observable es accesible a través de su propiedad <code>value</code></p>
<div class="highlight"><pre><span></span><code><span class="bp">print</span><span class="p">(</span><span class="n">textoResp</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="c1">//imprimirá la cadena vacía</span>
<span class="n">textoResp</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="s">&quot;hola&quot;</span>
</code></pre></div>
<p>Para vincular una propiedad de un elemento de <code>UIKit</code> con un observable usamos el método <code>bind(to:)</code>. La librería Bond extiende los elementos de interfaz añadiéndoles una propiedad <code>reactive</code>. Dentro de esta es donde están las propiedades "vinculables". Por ejemplo el texto de un campo estaría en <code>reactive.text</code>, el color en <code>reactive.textColor</code>, etc.</p>
<p>Supongamos que en la vista tenemos el <em>viewmodel</em> accesible en la propiedad <code>viewModel</code> (como veremos en el apartado siguiente). Entonces haríamos algo como:</p>
<div class="highlight"><pre><span></span><code><span class="kc">self</span><span class="p">.</span><span class="n">viewModel</span><span class="p">.</span><span class="n">textoResp</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span><span class="kc">self</span><span class="p">.</span><span class="n">labelRespuesta</span><span class="p">.</span><span class="n">reactive</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>
<p>para vincular el observable <code>textoResp</code> del <em>viewmodel</em> al texto de la etiqueta <code>labelRespuesta</code>. A partir de este momento cada vez que el <em>viewmodel</em> cambie el valor del observable se cambiará también el mensaje en la pantalla.</p>
<p>Vamos a ver ahora la vinculación entre el color de la respuesta y el que se muestra en pantalla. El <em>viewmodel</em> usa un tipo propio enumerado, <code>ColorRespuesta</code> para representar el color con que se debería mostrar la resupesta. Por tanto en el <em>viewmodel</em> crearemos un observable de este tipo con un valor inicial cualquiera.</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span> <span class="nv">colorResp</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="n">ColorRespuesta</span><span class="p">&gt;(.</span><span class="n">verde</span><span class="p">)</span>
</code></pre></div>
<blockquote>
<p>En iOS lo más sencillo para representar colores es usar la clase <code>UIColor</code>, pero recordemos que el <em>viewmodel</em> no debería contener código de <code>UIKit</code>, por eso usamos el tipo propio <code>ColorRespuesta</code>.</p>
</blockquote>
<p>Ahora el problema es que no podemos vincular directamente el color del <em>label</em> con este observable, ya que el color de los elementos de la interfaz es un <code>UIColor</code> y nosotros tenemos un tipo distinto. Sin embargo una idea bastante poderosa de <strong>los observables</strong> es que <strong>se pueden transformar</strong> y además de modo encadenado. Para ello se pueden usar las primitivas típicas de programación funcional (<code>map</code>, <code>filter</code>,...) y además algunas adicionales, dando lugar a lo que se conoce como FRP (<em>Functional Reactive Programming</em>). Por tanto lo que haremos será transformar el observable en un <code>UIColor</code> y vincular con este (ya que la transformación de un observable es también un observable, lo que nos permite encadenar operaciones). En la vista haríamos algo como:</p>
<div class="highlight"><pre><span></span><code><span class="n">viewModel</span><span class="p">.</span><span class="n">colorResp</span>
    <span class="p">.</span><span class="bp">map</span> <span class="p">{</span>
       <span class="n">color</span> <span class="k">in</span>
       <span class="k">return</span> <span class="p">(</span><span class="n">color</span> <span class="p">==</span> <span class="p">.</span><span class="n">verde</span> <span class="p">?</span> <span class="bp">UIColor</span><span class="p">.</span><span class="n">green</span> <span class="p">:</span> <span class="bp">UIColor</span><span class="p">.</span><span class="n">red</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">labelRespuesta</span><span class="p">.</span><span class="n">reactive</span><span class="p">.</span><span class="n">textColor</span><span class="p">)</span>
</code></pre></div>
<p>Recordemos que <code>map</code> parte de un valor y devuelve el valor transformado gracias a la clausura que se le pasa como parámetro.</p>
<h4 id="vinculacion-de-vista-a-viewmodel">Vinculación de vista a <em>viewmodel</em><a class="headerlink" href="#vinculacion-de-vista-a-viewmodel" title="Permanent link">&para;</a></h4>
<p>En el ejemplo de <code>UAdivino</code> no hay ningún caso de uso de vinculación en la dirección contraria, es decir, de la vista hacia el <em>viewmodel</em>, así que pondremos otro ejemplo. Supongamos un campo de texto en que el usuario escribe un texto de búsqueda. En la vista tendremos definido un <em>outlet</em> que referencie el campo de texto. Vincularemos desde la propiedad <code>reactive.text</code> del campo hacia la propiedad correspondiente del <em>viewmodel</em>. Pero cuidado, el destino no puede ser un tipo "normal" de Swift sino que debe ser un <code>Observable</code>
En el <em>viewmodel</em></p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span> <span class="nv">textoBusqueda</span> <span class="p">=</span> <span class="n">Observable</span><span class="p">&lt;</span><span class="nb">String</span><span class="p">&gt;(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</code></pre></div>
<p>En la vista, suponiendo que el <em>viewmodel</em> es accesible a través de la propiedad <code>viewModel</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kc">self</span><span class="p">.</span><span class="n">campoTexto</span><span class="p">.</span><span class="n">reactive</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span><span class="n">viewModel</span><span class="p">.</span><span class="n">textoBusqueda</span><span class="p">)</span>
</code></pre></div>
<p>Podemos establecer también una <strong>vinculación bidireccional</strong> de modo que cuando cambie cualquiera de los dos lados cambie el otro (de la propiedad a la vista y viceversa). Esto lo haríamos simplemente usando <code>bidirectionalBind</code> en lugar de <code>bind</code></p>
<div class="highlight"><pre><span></span><code><span class="kc">self</span><span class="p">.</span><span class="n">campoTexto</span><span class="p">.</span><span class="n">reactive</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">bidirectionalBind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span><span class="n">viewModel</span><span class="p">.</span><span class="n">textoBusqueda</span><span class="p">)</span>
</code></pre></div>
<h4 id="ensamblaje-de-modelo-viewmodel-y-vista">"Ensamblaje" de modelo, <em>viewmodel</em> y vista<a class="headerlink" href="#ensamblaje-de-modelo-viewmodel-y-vista" title="Permanent link">&para;</a></h4>
<p>Al igual que en el caso de MVP, hay que conectar las "piezas": modelo, <em>viewmodel</em> y vista. Como según el esquema del patrón la vista "posee" al <em>viewmodel</em>, definiremos este como una propiedad de la vista:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">UAdivinoView</span> <span class="p">:</span> <span class="bp">UIViewController</span> <span class="p">{</span>
   <span class="kd">let</span> <span class="nv">viewModel</span> <span class="p">=</span> <span class="n">UAdivinoViewModel</span><span class="p">()</span>
   <span class="p">...</span>
<span class="p">}</span> 
</code></pre></div>
<p>Y como el <em>viewmodel</em> "posee" al modelo definiremos este como una propiedad del primero:</p>
<div class="highlight"><pre><span></span><code><span class="kd">class</span> <span class="nc">UAdivinoViewModel</span> <span class="p">{</span>
   <span class="kd">let</span> <span class="nv">model</span> <span class="p">=</span> <span class="n">UAdivinoModel</span><span class="p">(</span><span class="n">nombre</span><span class="p">:</span> <span class="s">&quot;Rappel&quot;</span><span class="p">)</span>
   <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
<p>En MVVM, una parte importante del ensamblaje es <strong>inicializar los <em>bindings</em></strong>. Una forma sencilla de hacer esto es en el <code>viewDidLoad</code> de la vista:</p>
<div class="highlight"><pre><span></span><code><span class="kr">override</span> <span class="kd">func</span> <span class="nf">viewDidLoad</span><span class="p">()</span> <span class="p">{</span>
   <span class="kc">self</span><span class="p">.</span><span class="n">bindViewModel</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">bindViewModel</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">//conectamos viewModel.textoResp -&gt; texto del label</span>
    <span class="n">viewModel</span><span class="p">.</span><span class="n">textoResp</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="kc">self</span><span class="p">.</span><span class="n">labelRespuesta</span><span class="p">.</span><span class="n">reactive</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copiar al portapapeles", "clipboard.copied": "Copiado al portapapeles", "search.config.lang": "es", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "B\u00fasqueda", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.term.missing": "Falta", "select.version.title": "Seleccionar versi\u00f3n"}, "search": "../../assets/javascripts/workers/search.e99e714c.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.bc35569b.min.js"></script>
      
    
  </body>
</html>